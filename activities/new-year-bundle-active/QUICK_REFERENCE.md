# 新年組合活動 - 快速參考卡

## 🚀 核心功能速查

### 三大已實現機制

| 機制 | 實現方式 | 配置位置 |
|------|----------|----------|
| **問題1：全館折扣互斥** | 自動檢測並移除全館折扣券 | `NYB_GLOBAL_DISCOUNT_COUPONS` |
| **問題2：虛擬床包顯示** | 原價顯示+劃線+$0售價 | `NYB_BEDDING_VALUE_MAP` |
| **問題3：贈品鎖定** | 禁止移除+禁止改數量 | 自動生效 |

---

## 📝 常用操作

### 修改活動時間
```php
// new-year-bundle-active.php
define( 'NYB_CAMPAIGN_START', '2025-01-05 00:00:00' );
define( 'NYB_CAMPAIGN_END', '2026-02-28 23:59:59' );
```

### 添加全館折扣券代碼
```php
// new-year-bundle-active.php
define( 'NYB_GLOBAL_DISCOUNT_COUPONS', [
    'GLOBAL10',
    'YOUR_NEW_COUPON',  // 新增這行
] );
```

### 開啟/關閉除錯模式
```php
// new-year-bundle-active.php
define( 'NYB_DEBUG_MODE', true );  // 開啟
define( 'NYB_DEBUG_MODE', false ); // 關閉（生產環境）
```

### 查看日誌
```bash
tail -f /var/log/php-errors.log | grep "NYB"
```

---

## 🔍 除錯工具使用

### 啟用條件
- `NYB_DEBUG_MODE = true`
- 以管理員身份登入
- 訪問購物車頁面

### 功能
- ✅ 即時顯示購物車分析
- ✅ 顯示符合的規則
- ✅ 顯示所有購物車項目
- ✅ 一鍵清除贈品
- ✅ 一鍵重新驗證

---

## 🎯 規則優先級速查

```
規則7 (70) > 規則6 (60) > 規則5 (50) > 規則2 (40) > 規則1 (30) > 規則3 (20) > 規則4 (10)
```

### 互斥組

**combo_major**: 規則7、6、5、1（只觸發優先級最高的）
**pillow_gift**: 規則2、3（只觸發優先級最高的）
**獨立規則**: 規則4（可與其他規則共存）

---

## 🛠️ 故障排除

### 問題：贈品沒有自動添加
**檢查清單**:
1. 活動時間是否正確？
2. 商品ID是否在常數定義中？
3. 是否有互斥規則阻擋？
4. 查看除錯面板的「符合的規則」

### 問題：全館折扣券沒有被移除
**檢查清單**:
1. 優惠券代碼是否在 `NYB_GLOBAL_DISCOUNT_COUPONS`？
2. 是否為百分比折扣且無商品限制？
3. 查看日誌是否有 `Removed global discount coupon` 訊息

### 問題：虛擬床包價格顯示錯誤
**檢查清單**:
1. 床墊 variation_id 是否在 `NYB_BEDDING_VALUE_MAP`？
2. 查看除錯面板的「購物車項目」確認 variation_id
3. 檢查 `class-virtual-bedding-product.php` 的 `set_virtual_product_price()` 是否執行

---

## 📊 商品ID速查表

### 床墊
```php
// 嗜睡床墊（大地系列）
2735, 2736, 2737, 2738, 2739

// 嗜睡床墊（海洋系列）
4371, 4372, 4373, 4374, 4375

// 賴床墊
3446, 3445, 3447, 3448, 3695, 3696
```

### 枕頭
```php
// 催眠枕
2983, 2984, 3044
```

### 床架
```php
4930, 4929, 4422, 4423, 4424, 4425, 4426
```

### 贈品
```php
4180  // 兩用茸茸被
6346  // 抱枕
6300  // 眼罩
3044  // 側睡枕 (variation)
```

---

## 🔗 檔案結構

```
new-year-bundle-active/
├── new-year-bundle-active.php          # 主配置（修改這裡）
├── README.md                           # 完整文件
├── QUICK_REFERENCE.md                  # 本文件
└── helpers/
    ├── class-campaign-rule-engine.php  # 規則邏輯（新增規則）
    ├── class-cart-campaign-listener.php # 購物車事件（修改行為）
    ├── class-virtual-bedding-product.php # 虛擬商品（床包顯示）
    └── class-campaign-debugger.php     # 除錯工具（開發用）
```

---

## ⚡ 快速測試腳本

### 測試規則7（最高優先級）
```
1. 加入嗜睡床墊（任一尺寸）
2. 加入催眠枕 * 2
3. 加入賴床墊（任一尺寸）
4. 檢查購物車是否出現：天絲床包 + 茸茸被
```

### 測試全館折扣互斥
```
1. 加入嗜睡床墊 + 催眠枕（觸發規則1）
2. 套用全館折扣券
3. 檢查優惠券是否被自動移除
4. 檢查是否顯示提示訊息
```

### 測試贈品鎖定
```
1. 觸發任一規則
2. 嘗試點擊贈品的「移除」按鈕 → 應該沒有按鈕
3. 嘗試修改贈品數量 → 應該是純文字顯示
```

---

## 📞 需要協助？

### 檢查順序
1. **開啟除錯模式** → 查看除錯面板
2. **查看日誌** → 搜尋 `[NYB`
3. **確認商品ID** → 對照速查表
4. **測試規則優先級** → 參考互斥組

### 常見錯誤碼
- `Removed gift: xxx` → 規則不符，贈品被移除（正常）
- `Added gift: xxx` → 規則符合，贈品被添加（正常）
- `Removed global discount coupon` → 折扣券互斥（正常）
- `Campaign ended, removed all gifts` → 活動結束清理（正常）

---

## 🎨 前端提示訊息

### 購物車頁面
- 💡 黃色提示框：「再加購XX即可享受優惠」
- 🎁 藍色提示框：「您已享有以下優惠」

### 結帳頁面
- 🎁 藍色提示框：「您已享有以下優惠」

### 贈品標記
- 🎁 活動贈品（無法移除）
- 數量顯示：`1 (贈品)`

---

## ✅ 上線前檢查清單

- [ ] 設定正確的活動時間
- [ ] 關閉除錯模式 (`NYB_DEBUG_MODE = false`)
- [ ] 確認所有商品ID正確
- [ ] 測試所有7個規則
- [ ] 測試全館折扣互斥
- [ ] 測試活動結束後的清理
- [ ] 檢查贈品庫存是否充足
- [ ] 確認虛擬床包價格顯示正確

---

**版本**: 1.0
**最後更新**: 2025-01-05
**維護者**: 開發團隊

