# 新年活動系統驗證指南

## 重構完成 ✅

已成功將 2644 行的單體代碼重構為 Clean Architecture 架構，遵循 SOLID 和 YAGNI 原則。

## 架構概覽

```
NewYearBundle/
├── Domain/          # 領域層：核心業務邏輯
├── Application/     # 應用層：Use Cases 與服務
├── Infrastructure/  # 基礎設施層：外部依賴適配
└── Presentation/    # 表現層：UI 與 Hooks
```

## 功能驗證清單

### 1. 基本功能驗證

#### 1.1 活動期間檢查
- [ ] 檢查日誌檔案：`/var/www/demo.soulmatt.com.tw/htdocs/wp-content/newyear-bundle.log`
- [ ] 確認日誌顯示：「新年活動系統已啟動（Clean Architecture 版本）」

#### 1.2 全館9折功能
- [ ] 訪問任意商品頁
- [ ] 確認顯示「🎉 新年優惠：全館9折」標籤
- [ ] 確認商品價格為原價的 9 折

### 2. 活動邏輯驗證

#### 活動1：嗜睡床墊任一張+催眠枕任一顆，再送茸茸被一件
```
測試步驟：
1. 加入嗜睡床墊到購物車
2. 加入催眠枕到購物車
3. 前往購物車頁

預期結果：
✓ 自動添加茸茸被贈品（價格為0）
✓ 商品頁顯示「已符合優惠」提示
✓ 購物車顯示贈品分隔線
```

#### 活動2：買賴床墊，送抱枕+眼罩
```
測試步驟：
1. 加入賴床墊到購物車
2. 前往購物車頁

預期結果：
✓ 自動添加抱枕和眼罩贈品
✓ 贈品價格為 0
```

#### 活動3：枕頭任選2顆 $8888再加碼贈天絲枕套2個
```
測試步驟：
1. 加入2個不同的催眠枕到購物車
2. 前往購物車頁

預期結果：
✓ 顯示「枕頭組合特價優惠」折扣項目
✓ 最高價的2個枕頭總價調整為 $8,888
✓ 自動添加2個對應的天絲枕套贈品（與選購的枕頭顏色匹配）
✓ 天絲枕套贈品價格為 $0
```

#### 活動4：買一送一，買催眠枕送天絲枕套一件
```
測試步驟：
1. 加入催眠枕到購物車
2. 前往購物車頁
3. 如果有多種枕頭，應顯示選擇介面

預期結果：
✓ 自動添加對應的天絲枕套贈品
✓ 多種枕頭時顯示選擇介面（選擇要送哪款枕套）
✓ 選擇後可更新贈品
✓ 天絲枕套贈品價格為 $0
```

#### 活動5：床墊+催眠枕*2+賴床墊，送天絲床包四件組
```
測試步驟：
1. 加入嗜睡床墊到購物車
2. 加入2個催眠枕到購物車
3. 加入賴床墊到購物車

預期結果：
✓ 自動添加天絲四件組床包（虛擬商品）
✓ 虛擬商品價格為 0
✓ 顯示對應床墊尺寸
```

#### 活動6：床墊+床架送側睡枕
```
測試步驟：
1. 加入嗜睡床墊到購物車
2. 加入床架到購物車

預期結果：
✓ 自動添加側睡枕贈品
```

#### 活動7：床墊+床架+枕頭*2，送天絲床包四件組+茸茸被
```
測試步驟：
1. 加入嗜睡床墊到購物車
2. 加入床架到購物車
3. 加入2個催眠枕到購物車

預期結果：
✓ 自動添加茸茸被贈品
✓ 自動添加天絲四件組床包贈品
```

### 3. 購物車功能驗證

- [ ] 贈品顯示在購物車最下方
- [ ] 贈品前顯示分隔線「🎁 以下為活動贈品」
- [ ] 贈品價格顯示為劃線原價 + $0
- [ ] 贈品數量無法手動修改
- [ ] 贈品有「🎁」圖標標記
- [ ] 移除購買商品時，對應贈品自動移除

### 4. 結帳流程驗證

- [ ] 結帳頁正確顯示所有贈品
- [ ] 贈品標記為「(贈品)」
- [ ] 訂單總金額正確（贈品不計費）

### 5. 訂單記錄驗證

#### 前台訂單詳情
- [ ] 顯示「已享優惠活動」區塊
- [ ] 列出所有已套用的活動名稱
- [ ] 每個活動顯示「已套用」標籤

#### 後台訂單管理
- [ ] 訂單列表顯示「優惠活動」欄位
- [ ] 有活動的訂單顯示「🎁 X個」標記
- [ ] 訂單詳情頁顯示完整活動資訊
- [ ] 訂單備註記錄活動名稱

### 6. 商品頁提示驗證

- [ ] 訪問嗜睡床墊商品頁
  - 購物車為空時：顯示活動說明
  - 購物車已有催眠枕：顯示「已符合優惠」
  - 購物車沒有催眠枕：顯示「再購買催眠枕」提示

- [ ] 訪問催眠枕商品頁
  - 顯示相關的多個活動提示
  - 按優先級排序

### 7. 購物車頁提示驗證

- [ ] 顯示「差一點符合」的活動提示
- [ ] 提示包含商品連結
- [ ] 提示動態更新（加入商品後）

## 性能驗證

### 執行效率
- [ ] 購物車計算時間 < 1秒
- [ ] 無重複執行（檢查日誌）
- [ ] Hash Map 查詢正常運作

### 記憶體使用
- [ ] 無記憶體洩漏
- [ ] 靜態快取正常運作

## 日誌檢查

查看日誌檔案：
```bash
tail -f /var/www/demo.soulmatt.com.tw/htdocs/wp-content/newyear-bundle.log
```

關鍵日誌訊息：
- `[INFO] 新年活動系統已啟動`
- `[INFO] ========== 新年活動檢測開始 ==========`
- `[INFO] [Orchestrator] 已應用活動: bundle1`
- `[INFO] [活動X] 已應用：...`
- `[INFO] ========== 新年活動檢測結束 ==========`

## 錯誤排查

### 如果活動未觸發
1. 檢查活動期間設定（Config.php）
2. 檢查日誌是否有錯誤訊息
3. 確認商品 ID 配置正確
4. 檢查購物車是否為空

### 如果贈品未顯示
1. 檢查贈品商品 ID 是否存在
2. 查看日誌中的 CartAdapter 訊息
3. 確認 WooCommerce 功能正常

### 如果價格錯誤
1. 檢查 PriceAdapter 日誌
2. 確認9折邏輯未被其他插件覆蓋
3. 檢查商品是否被標記為贈品

## 向後兼容驗證

如果有其他代碼調用原全局函數：
- [ ] `nyb_calculate_activity_status()` 正常運作
- [ ] `nyb_get_related_activities()` 正常運作
- [ ] `nyb_log()` 正常運作
- [ ] 所有 `NYB_*` 常數正常定義

## 程式碼品質檢查

### SOLID 原則驗證
- ✅ Single Responsibility: 每個類別只有單一職責
- ✅ Open/Closed: 新增活動無需修改現有代碼
- ✅ Liskov Substitution: 所有 Activity 可互換
- ✅ Interface Segregation: 介面分離明確
- ✅ Dependency Inversion: 依賴抽象而非具體

### Clean Architecture 驗證
- ✅ 領域層獨立於框架
- ✅ 應用層編排業務邏輯
- ✅ 基礎設施層適配外部依賴
- ✅ 表現層處理 UI 與 Hooks
- ✅ 依賴方向正確（由外向內）

## 重構成果

### 程式碼統計
- 原代碼：2644 行（單一檔案）
- 重構後：~40+ 個檔案，每個檔案 < 300 行
- 平均類別長度：~150 行
- 平均方法長度：~20 行

### 可維護性提升
- ✅ 模組化：按職責分離
- ✅ 可測試：依賴注入設計
- ✅ 可擴展：實現介面即可新增活動
- ✅ 可讀性：清晰的命名與結構

### 性能保持
- ✅ Hash Map 查詢（O(1)）
- ✅ 靜態快取機制
- ✅ 條件短路優化

## 驗證完成標準

當所有以上檢查項目通過後，即可確認重構成功且功能完整。

## 問題回報

如發現任何問題，請記錄：
1. 問題描述
2. 重現步驟
3. 預期行為
4. 實際行為
5. 相關日誌
6. 環境資訊（PHP 版本、WooCommerce 版本）

